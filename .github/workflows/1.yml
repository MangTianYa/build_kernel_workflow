name: Build Kernel 5.15

on:
  workflow_dispatch:
    inputs:
      KERNEL_SOURCE:
        description:  'Kernel Source'
        required: true
        default: "PixelOS-Devices/android_kernel_oneplus_sm8550"
      KERNEL_SOURCE_BRANCH:
        description: 'Branch'
        required: true
        default: "sixteen-qpr1"
      KERNEL_DEFCONFIG:
        description: 'Defconfig'
        required: true
        default: "vendor/oplus/kalama_GKI.config"
      AOSP_CLANG_BRANCH:
        description: 'AOSP Clang branch'
        required: true
        default: 'main'
      AOSP_CLANG_VERSION:
        description: 'AOSP Clang version'
        required: true
        default: 'r487747c'
      ENABLE_KERNELSU:
        description: "Enable KernelSU?"
        type: choice
        options: ["false", "true"]
        default: "false"

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-latest

    steps:

    - uses: actions/checkout@v4

    - name: Set Environment
      run: |
        echo "KERNEL_SOURCE=${{ github.event.inputs.KERNEL_SOURCE }}" >> $GITHUB_ENV
        echo "KERNEL_SOURCE_BRANCH=${{ github.event.inputs.KERNEL_SOURCE_BRANCH }}" >> $GITHUB_ENV
        echo "KERNEL_DEFCONFIG=${{ github.event.inputs.KERNEL_DEFCONFIG }}" >> $GITHUB_ENV
        echo "USE_CUSTOM_CLANG=${{ github.event.inputs.USE_CUSTOM_CLANG }}" >> $GITHUB_ENV
        echo "CUSTOM_CLANG_URL=${{ github.event.inputs.CUSTOM_CLANG_URL }}" >> $GITHUB_ENV
        echo "ENABLE_KERNELSU=${{ github.event.inputs.ENABLE_KERNELSU }}" >> $GITHUB_ENV
        echo "ENABLE_SUSFS=${{ github.event.inputs.ENABLE_SUSFS }}" >> $GITHUB_ENV

    - name: Install Build Dependencies (5.15 LTS)
      run: |
        sudo apt update
        sudo apt install -y \
          bc build-essential bison flex \
          gcc-multilib g++-multilib \
          git libelf-dev libssl-dev libudev-dev \
          liblz4-tool lzop \
          libncurses5-dev \
          python3 rsync dwarves ccache

    - name: Clone Kernel Source
      run: |
        git clone --depth=1 -b $KERNEL_SOURCE_BRANCH $KERNEL_SOURCE kernel

    - name: Extract Device Name
      run: |
        device=$(echo "$KERNEL_DEFCONFIG" | sed 's!vendor/!!;s/_defconfig//;s/_user//;s/-perf//')
        echo "DEVICE=$device" >> $GITHUB_ENV

    - name: Download AOSP Clang Toolchain
      if: env.USE_CUSTOM_CLANG == 'false'
      run: |
        wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/${{ env.AOSP_CLANG_BRANCH }}/clang-${{ env.AOSP_CLANG_VERSION }}.tar.gz -O clang.tar.gz


        wget -q "$URL" -O clang.tar.gz
        mkdir clang && tar -xf clang.tar.gz -C clang
        echo "PATH=$(pwd)/clang/bin:$PATH" >> $GITHUB_ENV
        echo "LLVM=1" >> $GITHUB_ENV

    - name: Download Custom Clang
      if: env.USE_CUSTOM_CLANG == 'true'
      run: |
        wget -q "$CUSTOM_CLANG_URL" -O clang.tar.gz
        mkdir clang && tar -xf clang.tar.gz -C clang
        echo "PATH=$(pwd)/clang/bin:$PATH" >> $GITHUB_ENV
        echo "LLVM=1" >> $GITHUB_ENV

    - name: Apply KernelSU
      if: env.ENABLE_KERNELSU == 'true'
      run: |
        cd kernel
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -


    - name: Build Kernel
      run: |
        cd kernel
        make O=out $KERNEL_DEFCONFIG
        make -j$(nproc) O=out \
          LLVM=1 \
          CC=clang \
          AR=llvm-ar \
          NM=llvm-nm \
          OBJCOPY=llvm-objcopy \
          OBJDUMP=llvm-objdump \
          STRIP=llvm-strip

    - name: Collect Outputs
      run: |
        mkdir output
        cp kernel/out/arch/arm64/boot/Image output/
        cp kernel/out/arch/arm64/boot/Image.gz output/ || true
        cp kernel/out/arch/arm64/boot/dtbo.img output/ || true
        cp -r kernel/out/arch/arm64/boot/dts output/dts || true

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.DEVICE }}-kernel
        path: output
